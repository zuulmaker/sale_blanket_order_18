<?xml version="1.0" encoding="utf-8"?>
<!--
# Copyright 2025 j.s.drees@az-zwick.com & kd.gundermann@az-zwick.com
# License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl).
# Date: 2025-06-03
# Authors: J.s.drees@az-zwick.com & kd.gundermann@az-zwick.com
Sale Blanket Order Mail Templates - Robuste E-Mail-Kommunikation für Odoo 18.0
==============================================================================

Fehlertolerante und mehrsprachige E-Mail-Vorlagen für Blanket Order Kommunikation.

Anwendungsbeispiele:
- Automatische Benachrichtigung bei Blanket Order Bestätigung
- Erinnerungen vor Ablauf der Gültigkeitsdauer
- Information bei Sale Order Erstellung aus Blanket Order
- Quarterly Reports über Blanket Order Nutzung
- Partner-spezifische E-Mail-Anpassungen
-->

<odoo>
    <data noupdate="1">

        <!-- ===================================================================== -->
        <!-- BLANKET ORDER CONFIRMATION - Bestätigungs-E-Mail -->
        <!-- ===================================================================== -->

        <record id="mail_template_blanket_order_confirmation" model="mail.template">
            <field name="name">Blanket Order Confirmation</field>
            <field name="model_id" ref="model_sale_blanket_order"/>
            <field name="subject">{{ object.company_id.name }} - Blanket Order {{ object.name }} Confirmed</field>
            <field name="email_from">{{ (object.user_id.email or object.company_id.email or 'noreply@example.com') }}</field>
            <field name="email_to">{{ object.partner_id.email }}</field>
            <field name="lang">{{ object.partner_id.lang }}</field>
            <field name="auto_delete">False</field>
            <field name="body_html" type="html">
<div style="margin:0px;padding:0px;font-family:'Lucida Grande',Ubuntu,Arial,Verdana,sans-serif;font-size:14px;color:rgb(34,34,34);background-color:#FFFFFF;">
    
    <!-- ✅ GEÄNDERT: Modernes Header-Design für 18.0 -->
    <table cellpadding="0" cellspacing="0" style="width:100%;margin:0px;background-color:#F8F9FA;">
        <tr>
            <td style="padding:20px;">
                <table cellpadding="0" cellspacing="0" style="width:100%;max-width:600px;margin:0px auto;background-color:#FFFFFF;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                    
                    <!-- Header -->
                    <tr>
                        <td style="padding:30px;background-color:#007B5F;border-radius:8px 8px 0 0;">
                            <table cellpadding="0" cellspacing="0" style="width:100%;">
                                <tr>
                                    <td style="vertical-align:middle;">
                                        <h1 style="margin:0px;color:#FFFFFF;font-size:24px;font-weight:bold;">
                                            ✅ Blanket Order Confirmed
                                        </h1>
                                        <p style="margin:5px 0 0 0;color:#E8F5E8;font-size:16px;">
                                            Order {{ object.name or 'N/A' }} has been successfully confirmed
                                        </p>
                                    </td>
                                    <td style="vertical-align:middle;text-align:right;">
                                        % if object.company_id.logo:
                                        <img src="data:image/png;base64,{{ object.company_id.logo.decode() }}" 
                                             alt="{{ object.company_id.name }}" 
                                             style="max-height:60px;max-width:150px;"/>
                                        % endif
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>

                    <!-- Content -->
                    <tr>
                        <td style="padding:30px;">
                            
                            <!-- Greeting -->
                            <p style="margin:0 0 20px 0;font-size:16px;">
                                Hello <strong>{{ object.partner_id.name or 'Valued Customer' }}</strong>,
                            </p>
                            
                            <p style="margin:0 0 20px 0;line-height:1.6;">
                                We are pleased to confirm that your Blanket Order has been successfully processed and is now active. 
                                You can now create Sale Orders based on this framework agreement.
                            </p>

                            <!-- ✅ NEU: Order Details Card -->
                            <table cellpadding="0" cellspacing="0" style="width:100%;margin:20px 0;border:1px solid #E9ECEF;border-radius:6px;">
                                <tr>
                                    <td style="padding:20px;background-color:#F8F9FA;border-bottom:1px solid #E9ECEF;border-radius:6px 6px 0 0;">
                                        <h3 style="margin:0;color:#495057;font-size:18px;">📋 Order Details</h3>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding:20px;">
                                        <table cellpadding="0" cellspacing="0" style="width:100%;">
                                            <tr>
                                                <td style="padding:5px 0;width:40%;"><strong>Order Number:</strong></td>
                                                <td style="padding:5px 0;color:#007B5F;"><strong>{{ object.name or 'N/A' }}</strong></td>
                                            </tr>
                                            <tr>
                                                <td style="padding:5px 0;"><strong>Valid Until:</strong></td>
                                                <td style="padding:5px 0;">
                                                    % if object.validity_date:
                                                        {{ format_date(object.validity_date, lang_code=object.partner_id.lang) }}
                                                    % else:
                                                        Not specified
                                                    % endif
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="padding:5px 0;"><strong>Total Amount:</strong></td>
                                                <td style="padding:5px 0;">
                                                    <strong style="color:#28A745;">
                                                        {{ format_amount(object.amount_total, object.currency_id) }}
                                                    </strong>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="padding:5px 0;"><strong>Sales Person:</strong></td>
                                                <td style="padding:5px 0;">{{ object.user_id.name or 'Not assigned' }}</td>
                                            </tr>
                                            % if object.client_order_ref:
                                            <tr>
                                                <td style="padding:5px 0;"><strong>Your Reference:</strong></td>
                                                <td style="padding:5px 0;">{{ object.client_order_ref }}</td>
                                            </tr>
                                            % endif
                                        </table>
                                    </td>
                                </tr>
                            </table>

                            <!-- ✅ NEU: Order Lines Summary -->
                            % if object.line_ids:
                            <table cellpadding="0" cellspacing="0" style="width:100%;margin:20px 0;border:1px solid #E9ECEF;border-radius:6px;">
                                <tr>
                                    <td style="padding:20px;background-color:#F8F9FA;border-bottom:1px solid #E9ECEF;border-radius:6px 6px 0 0;">
                                        <h3 style="margin:0;color:#495057;font-size:18px;">📦 Order Lines Summary</h3>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding:20px;">
                                        <table cellpadding="8" cellspacing="0" style="width:100%;border-collapse:collapse;">
                                            <thead>
                                                <tr style="background-color:#F8F9FA;">
                                                    <th style="text-align:left;padding:10px;border-bottom:2px solid #DEE2E6;">Product</th>
                                                    <th style="text-align:right;padding:10px;border-bottom:2px solid #DEE2E6;">Quantity</th>
                                                    <th style="text-align:right;padding:10px;border-bottom:2px solid #DEE2E6;">Unit Price</th>
                                                    <th style="text-align:right;padding:10px;border-bottom:2px solid #DEE2E6;">Subtotal</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                % for line in object.line_ids[:5]:  <!-- Zeige max 5 Lines -->
                                                    % if not line.display_type:
                                                    <tr>
                                                        <td style="padding:8px;border-bottom:1px solid #E9ECEF;">
                                                            <strong>{{ line.product_id.name or 'Product' }}</strong>
                                                            % if line.product_id.code:
                                                            <br/><small style="color:#6C757D;">[{{ line.product_id.code }}]</small>
                                                            % endif
                                                        </td>
                                                        <td style="text-align:right;padding:8px;border-bottom:1px solid #E9ECEF;">
                                                            {{ line.original_uom_qty }} {{ line.product_uom.name or '' }}
                                                        </td>
                                                        <td style="text-align:right;padding:8px;border-bottom:1px solid #E9ECEF;">
                                                            {{ format_amount(line.price_unit, object.currency_id) }}
                                                        </td>
                                                        <td style="text-align:right;padding:8px;border-bottom:1px solid #E9ECEF;">
                                                            <strong>{{ format_amount(line.price_subtotal, object.currency_id) }}</strong>
                                                        </td>
                                                    </tr>
                                                    % endif
                                                % endfor
                                                
                                                % if len(object.line_ids.filtered(lambda l: not l.display_type)) > 5:
                                                <tr>
                                                    <td colspan="4" style="padding:8px;text-align:center;color:#6C757D;font-style:italic;">
                                                        ... and {{ len(object.line_ids.filtered(lambda l: not l.display_type)) - 5 }} more lines
                                                    </td>
                                                </tr>
                                                % endif
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                            % endif

                            <!-- Next Steps -->
                            <div style="margin:30px 0;padding:20px;background-color:#E8F4FD;border-left:4px solid #007B5F;border-radius:4px;">
                                <h3 style="margin:0 0 10px 0;color:#495057;font-size:16px;">🚀 Next Steps</h3>
                                <ul style="margin:10px 0;padding-left:20px;line-height:1.6;">
                                    <li>You can now create Sale Orders based on this Blanket Order</li>
                                    <li>Contact your sales representative for assistance with order creation</li>
                                    <li>Monitor your usage through our customer portal</li>
                                    % if object.validity_date:
                                    <li>Remember: This order is valid until {{ format_date(object.validity_date, lang_code=object.partner_id.lang) }}</li>
                                    % endif
                                </ul>
                            </div>

                            <!-- Contact Information -->
                            <p style="margin:20px 0 0 0;line-height:1.6;">
                                If you have any questions about this Blanket Order, please don't hesitate to contact 
                                % if object.user_id and object.user_id.email:
                                your sales representative <strong>{{ object.user_id.name }}</strong> at 
                                <a href="mailto:{{ object.user_id.email }}" style="color:#007B5F;">{{ object.user_id.email }}</a>
                                % else:
                                our sales team at <a href="mailto:{{ object.company_id.email or 'sales@example.com' }}" style="color:#007B5F;">{{ object.company_id.email or 'sales@example.com' }}</a>
                                % endif
                            </p>

                            <p style="margin:20px 0 0 0;">
                                Thank you for your business!
                            </p>
                        </td>
                    </tr>

                    <!-- Footer -->
                    <tr>
                        <td style="padding:20px;background-color:#F8F9FA;border-radius:0 0 8px 8px;text-align:center;">
                            <p style="margin:0;color:#6C757D;font-size:12px;">
                                <strong>{{ object.company_id.name }}</strong><br/>
                                % if object.company_id.street:
                                {{ object.company_id.street }}
                                % if object.company_id.street2:
                                , {{ object.company_id.street2 }}
                                % endif
                                <br/>
                                % endif
                                % if object.company_id.zip or object.company_id.city:
                                {{ object.company_id.zip or '' }} {{ object.company_id.city or '' }}
                                % if object.company_id.country_id:
                                , {{ object.company_id.country_id.name }}
                                % endif
                                <br/>
                                % endif
                                % if object.company_id.phone:
                                Phone: {{ object.company_id.phone }}<br/>
                                % endif
                                % if object.company_id.email:
                                Email: <a href="mailto:{{ object.company_id.email }}" style="color:#007B5F;">{{ object.company_id.email }}</a>
                                % endif
                            </p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</div>
            </field>
            <field name="report_template" ref="action_report_blanket_order"/>
            <field name="attachment_ids" eval="[(6, 0, [])]"/>
        </record>

        <!-- ===================================================================== -->
        <!-- EXPIRY REMINDER - Erinnerung vor Ablauf -->
        <!-- ===================================================================== -->

        <record id="mail_template_blanket_order_expiry_reminder" model="mail.template">
            <field name="name">Blanket Order Expiry Reminder</field>
            <field name="model_id" ref="model_sale_blanket_order"/>
            <field name="subject">⏰ Reminder: Blanket Order {{ object.name }} expires soon</field>
            <field name="email_from">{{ (object.user_id.email or object.company_id.email or 'noreply@example.com') }}</field>
            <field name="email_to">{{ object.partner_id.email }}</field>
            <field name="lang">{{ object.partner_id.lang }}</field>
            <field name="auto_delete">True</field>
            <field name="body_html" type="html">
<div style="margin:0px;padding:0px;font-family:'Lucida Grande',Ubuntu,Arial,Verdana,sans-serif;font-size:14px;color:rgb(34,34,34);background-color:#FFFFFF;">
    
    <table cellpadding="0" cellspacing="0" style="width:100%;margin:0px;background-color:#FFF8E1;">
        <tr>
            <td style="padding:20px;">
                <table cellpadding="0" cellspacing="0" style="width:100%;max-width:600px;margin:0px auto;background-color:#FFFFFF;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                    
                    <!-- Header -->
                    <tr>
                        <td style="padding:30px;background-color:#FF9800;border-radius:8px 8px 0 0;">
                            <h1 style="margin:0px;color:#FFFFFF;font-size:24px;font-weight:bold;">
                                ⏰ Expiry Reminder
                            </h1>
                            <p style="margin:5px 0 0 0;color:#FFF3E0;font-size:16px;">
                                Your Blanket Order {{ object.name or 'N/A' }} expires soon
                            </p>
                        </td>
                    </tr>

                    <!-- Content -->
                    <tr>
                        <td style="padding:30px;">
                            
                            <p style="margin:0 0 20px 0;font-size:16px;">
                                Hello <strong>{{ object.partner_id.name or 'Valued Customer' }}</strong>,
                            </p>
                            
                            <div style="margin:20px 0;padding:20px;background-color:#FFF3E0;border-left:4px solid #FF9800;border-radius:4px;">
                                <h3 style="margin:0 0 10px 0;color:#F57C00;font-size:18px;">📅 Important Notice</h3>
                                <p style="margin:0;line-height:1.6;">
                                    Your Blanket Order <strong>{{ object.name }}</strong> will expire on 
                                    <strong style="color:#D84315;">{{ format_date(object.validity_date, lang_code=object.partner_id.lang) if object.validity_date else 'Date not specified' }}</strong>.
                                </p>
                            </div>

                            <!-- Remaining Usage -->
                            % if object.remaining_uom_qty > 0:
                            <table cellpadding="0" cellspacing="0" style="width:100%;margin:20px 0;border:1px solid #FFE0B2;border-radius:6px;">
                                <tr>
                                    <td style="padding:20px;background-color:#FFF8E1;border-bottom:1px solid #FFE0B2;border-radius:6px 6px 0 0;">
                                        <h3 style="margin:0;color:#F57C00;font-size:18px;">📊 Remaining Usage</h3>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding:20px;">
                                        <div style="margin-bottom:15px;">
                                            <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                                                <span><strong>Used:</strong></span>
                                                <span>{{ object.ordered_uom_qty or 0 }} / {{ object.original_uom_qty or 0 }}</span>
                                            </div>
                                            <div style="width:100%;background-color:#F5F5F5;border-radius:4px;height:20px;">
                                                % set usage_percent = (object.ordered_uom_qty / object.original_uom_qty * 100) if object.original_uom_qty else 0
                                                <div style="width:{{ usage_percent }}%;background-color:#4CAF50;height:20px;border-radius:4px;"></div>
                                            </div>
                                        </div>
                                        <p style="margin:10px 0 0 0;color:#F57C00;">
                                            <strong>{{ object.remaining_uom_qty }} units remaining</strong> - don't let them expire!
                                        </p>
                                    </td>
                                </tr>
                            </table>
                            % endif

                            <!-- Action Items -->
                            <div style="margin:30px 0;padding:20px;background-color:#E8F5E8;border-left:4px solid #4CAF50;border-radius:4px;">
                                <h3 style="margin:0 0 10px 0;color:#2E7D32;font-size:16px;">✅ Recommended Actions</h3>
                                <ul style="margin:10px 0;padding-left:20px;line-height:1.6;">
                                    % if object.remaining_uom_qty > 0:
                                    <li><strong>Create Sale Orders</strong> to use your remaining allocation</li>
                                    % endif
                                    <li><strong>Renew your Blanket Order</strong> if you need continued access</li>
                                    <li><strong>Contact your sales representative</strong> to discuss options</li>
                                    <li><strong>Review your usage patterns</strong> for future planning</li>
                                </ul>
                            </div>

                            <p style="margin:20px 0 0 0;line-height:1.6;">
                                To discuss renewal options or create additional Sale Orders, please contact 
                                % if object.user_id and object.user_id.email:
                                <strong>{{ object.user_id.name }}</strong> at 
                                <a href="mailto:{{ object.user_id.email }}" style="color:#FF9800;">{{ object.user_id.email }}</a>
                                % else:
                                our sales team at <a href="mailto:{{ object.company_id.email or 'sales@example.com' }}" style="color:#FF9800;">{{ object.company_id.email or 'sales@example.com' }}</a>
                                % endif
                            </p>
                        </td>
                    </tr>

                    <!-- Footer -->
                    <tr>
                        <td style="padding:20px;background-color:#FFF8E1;border-radius:0 0 8px 8px;text-align:center;">
                            <p style="margin:0;color:#6C757D;font-size:12px;">
                                This is an automated reminder. You will receive this notification 30, 14, and 7 days before expiry.
                            </p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</div>
            </field>
        </record>

        <!-- ===================================================================== -->
        <!-- SALE ORDER CREATED - Benachrichtigung bei SO-Erstellung -->
        <!-- ===================================================================== -->

        <record id="mail_template_sale_order_from_blanket" model="mail.template">
            <field name="name">Sale Order Created from Blanket Order</field>
            <field name="model_id" ref="sale.model_sale_order"/>
            <field name="subject">📋 Sale Order {{ object.name }} created from your Blanket Order</field>
            <field name="email_from">{{ (object.user_id.email or object.company_id.email or 'noreply@example.com') }}</field>
            <field name="email_to">{{ object.partner_id.email }}</field>
            <field name="lang">{{ object.partner_id.lang }}</field>
            <field name="auto_delete">True</field>
            <field name="body_html" type="html">
<div style="margin:0px;padding:0px;font-family:'Lucida Grande',Ubuntu,Arial,Verdana,sans-serif;font-size:14px;color:rgb(34,34,34);background-color:#FFFFFF;">
    
    <table cellpadding="0" cellspacing="0" style="width:100%;margin:0px;background-color:#E3F2FD;">
        <tr>
            <td style="padding:20px;">
                <table cellpadding="0" cellspacing="0" style="width:100%;max-width:600px;margin:0px auto;background-color:#FFFFFF;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                    
                    <!-- Header -->
                    <tr>
                        <td style="padding:30px;background-color:#2196F3;border-radius:8px 8px 0 0;">
                            <h1 style="margin:0px;color:#FFFFFF;font-size:24px;font-weight:bold;">
                                📋 Sale Order Created
                            </h1>
                            <p style="margin:5px 0 0 0;color:#E3F2FD;font-size:16px;">
                                New order {{ object.name or 'N/A' }} from your Blanket Order
                            </p>
                        </td>
                    </tr>

                    <!-- Content -->
                    <tr>
                        <td style="padding:30px;">
                            
                            <p style="margin:0 0 20px 0;font-size:16px;">
                                Hello <strong>{{ object.partner_id.name or 'Valued Customer' }}</strong>,
                            </p>
                            
                            <p style="margin:0 0 20px 0;line-height:1.6;">
                                We have successfully created a new Sale Order from your Blanket Order. 
                                This order is now ready for processing and delivery.
                            </p>

                            <!-- Order Details -->
                            <table cellpadding="0" cellspacing="0" style="width:100%;margin:20px 0;border:1px solid #E1F5FE;border-radius:6px;">
                                <tr>
                                    <td style="padding:20px;background-color:#E3F2FD;border-bottom:1px solid #E1F5FE;border-radius:6px 6px 0 0;">
                                        <h3 style="margin:0;color:#1976D2;font-size:18px;">📋 Order Information</h3>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding:20px;">
                                        <table cellpadding="0" cellspacing="0" style="width:100%;">
                                            <tr>
                                                <td style="padding:5px 0;width:40%;"><strong>Sale Order:</strong></td>
                                                <td style="padding:5px 0;color:#1976D2;"><strong>{{ object.name or 'N/A' }}</strong></td>
                                            </tr>
                                            % set blanket_orders = object.order_line.mapped('blanket_order_line.order_id').filtered('exists')
                                            % if blanket_orders:
                                            <tr>
                                                <td style="padding:5px 0;"><strong>From Blanket Order:</strong></td>
                                                <td style="padding:5px 0;">
                                                    % for bo in blanket_orders[:3]:  <!-- Max 3 anzeigen -->
                                                    {{ bo.name }}{% if not loop.last %}, {% endif %}
                                                    % endfor
                                                    % if len(blanket_orders) > 3:
                                                    and {{ len(blanket_orders) - 3 }} more
                                                    % endif
                                                </td>
                                            </tr>
                                            % endif
                                            <tr>
                                                <td style="padding:5px 0;"><strong>Order Date:</strong></td>
                                                <td style="padding:5px 0;">{{ format_date(object.date_order, lang_code=object.partner_id.lang) if object.date_order else 'N/A' }}</td>
                                            </tr>
                                            <tr>
                                                <td style="padding:5px 0;"><strong>Total Amount:</strong></td>
                                                <td style="padding:5px 0;">
                                                    <strong style="color:#4CAF50;">
                                                        {{ format_amount(object.amount_total, object.currency_id) }}
                                                    </strong>
                                                </td>
                                            </tr>
                                            % if object.commitment_date:
                                            <tr>
                                                <td style="padding:5px 0;"><strong>Expected Delivery:</strong></td>
                                                <td style="padding:5px 0;">{{ format_date(object.commitment_date, lang_code=object.partner_id.lang) }}</td>
                                            </tr>
                                            % endif
                                        </table>
                                    </td>
                                </tr>
                            </table>

                            <!-- Next Steps -->
                            <div style="margin:30px 0;padding:20px;background-color:#E8F5E8;border-left:4px solid #4CAF50;border-radius:4px;">
                                <h3 style="margin:0 0 10px 0;color:#2E7D32;font-size:16px;">🚀 What happens next?</h3>
                                <ol style="margin:10px 0;padding-left:20px;line-height:1.6;">
                                    <li>Your order will be processed by our team</li>
                                    <li>You will receive a confirmation once the order is validated</li>
                                    <li>We'll notify you when your order ships</li>
                                    <li>Track your delivery through our customer portal</li>
                                </ol>
                            </div>

                            <p style="margin:20px 0 0 0;line-height:1.6;">
                                If you have any questions about this order, please contact 
                                % if object.user_id and object.user_id.email:
                                your sales representative <strong>{{ object.user_id.name }}</strong> at 
                                <a href="mailto:{{ object.user_id.email }}" style="color:#2196F3;">{{ object.user_id.email }}</a>
                                % else:
                                our sales team at <a href="mailto:{{ object.company_id.email or 'sales@example.com' }}" style="color:#2196F3;">{{ object.company_id.email or 'sales@example.com' }}</a>
                                % endif
                            </p>
                        </td>
                    </tr>

                    <!-- Footer -->
                    <tr>
                        <td style="padding:20px;background-color:#E3F2FD;border-radius:0 0 8px 8px;text-align:center;">
                            <p style="margin:0;color:#6C757D;font-size:12px;">
                                Thank you for using our Blanket Order system. We appreciate your business!
                            </p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</div>
            </field>
        </record>

        <!-- ===================================================================== -->
        <!-- QUARTERLY USAGE REPORT - Quarterly Report über Blanket Order Nutzung -->
        <!-- ===================================================================== -->

        <record id="mail_template_blanket_order_quarterly_report" model="mail.template">
            <field name="name">Blanket Order Quarterly Usage Report</field>
            <field name="model_id" ref="base.model_res_partner"/>
            <field name="subject">📊 Quarterly Blanket Order Report - {{ ctx.get('quarter', 'Q1') }} {{ ctx.get('year', '2025') }}</field>
            <field name="email_from">{{ user.email or 'noreply@example.com' }}</field>
            <field name="email_to">{{ object.email }}</field>
            <field name="lang">{{ object.lang }}</field>
            <field name="auto_delete">False</field>
            <field name="body_html" type="html">
<div style="margin:0px;padding:0px;font-family:'Lucida Grande',Ubuntu,Arial,Verdana,sans-serif;font-size:14px;color:rgb(34,34,34);background-color:#FFFFFF;">
    
    <table cellpadding="0" cellspacing="0" style="width:100%;margin:0px;background-color:#F3E5F5;">
        <tr>
            <td style="padding:20px;">
                <table cellpadding="0" cellspacing="0" style="width:100%;max-width:700px;margin:0px auto;background-color:#FFFFFF;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                    
                    <!-- Header -->
                    <tr>
                        <td style="padding:30px;background-color:#9C27B0;border-radius:8px 8px 0 0;">
                            <h1 style="margin:0px;color:#FFFFFF;font-size:28px;font-weight:bold;">
                                📊 Quarterly Report
                            </h1>
                            <p style="margin:5px 0 0 0;color:#F3E5F5;font-size:18px;">
                                Blanket Order Usage Summary - {{ ctx.get('quarter', 'Q1') }} {{ ctx.get('year', '2025') }}
                            </p>
                        </td>
                    </tr>

                    <!-- Content -->
                    <tr>
                        <td style="padding:30px;">
                            
                            <p style="margin:0 0 20px 0;font-size:16px;">
                                Hello <strong>{{ object.name or 'Valued Customer' }}</strong>,
                            </p>
                            
                            <p style="margin:0 0 30px 0;line-height:1.6;">
                                We're pleased to provide you with your quarterly Blanket Order usage report. 
                                This summary shows your activity and helps you plan for future orders.
                            </p>

                            <!-- Key Metrics -->
                            <table cellpadding="0" cellspacing="0" style="width:100%;margin:20px 0;">
                                <tr>
                                    <td style="width:25%;padding:20px;text-align:center;background-color:#E8F5E8;border-radius:6px;margin:5px;">
                                        <h3 style="margin:0;color:#4CAF50;font-size:32px;">{{ ctx.get('active_orders', '0') }}</h3>
                                        <p style="margin:5px 0 0 0;color:#2E7D32;font-weight:bold;">Active Orders</p>
                                    </td>
                                    <td style="width:25%;padding:20px;text-align:center;background-color:#E3F2FD;border-radius:6px;margin:5px;">
                                        <h3 style="margin:0;color:#2196F3;font-size:32px;">{{ ctx.get('sale_orders_created', '0') }}</h3>
                                        <p style="margin:5px 0 0 0;color:#1976D2;font-weight:bold;">Sale Orders</p>
                                    </td>
                                    <td style="width:25%;padding:20px;text-align:center;background-color:#FFF3E0;border-radius:6px;margin:5px;">
                                        <h3 style="margin:0;color:#FF9800;font-size:32px;">{{ ctx.get('usage_percentage', '0') }}%</h3>
                                        <p style="margin:5px 0 0 0;color:#F57C00;font-weight:bold;">Usage Rate</p>
                                    </td>
                                    <td style="width:25%;padding:20px;text-align:center;background-color:#F3E5F5;border-radius:6px;margin:5px;">
                                        <h3 style="margin:0;color:#9C27B0;font-size:32px;">{{ ctx.get('total_value', '€0') }}</h3>
                                        <p style="margin:5px 0 0 0;color:#7B1FA2;font-weight:bold;">Total Value</p>
                                    </td>
                                </tr>
                            </table>

                            <!-- Insights -->
                            <div style="margin:30px 0;padding:20px;background-color:#F8F9FA;border-left:4px solid #9C27B0;border-radius:4px;">
                                <h3 style="margin:0 0 15px 0;color:#9C27B0;font-size:18px;">💡 Key Insights</h3>
                                <ul style="margin:0;padding-left:20px;line-height:1.8;">
                                    <li>Your Blanket Order usage increased by <strong>{{ ctx.get('growth_percentage', '0') }}%</strong> compared to last quarter</li>
                                    <li>Most popular product category: <strong>{{ ctx.get('top_category', 'Various') }}</strong></li>
                                    <li>Average order size: <strong>{{ ctx.get('avg_order_size', '€0') }}</strong></li>
                                    <li>Peak ordering month: <strong>{{ ctx.get('peak_month', 'N/A') }}</strong></li>
                                </ul>
                            </div>

                            <!-- Recommendations -->
                            <div style="margin:30px 0;padding:20px;background-color:#E8F5E8;border-left:4px solid #4CAF50;border-radius:4px;">
                                <h3 style="margin:0 0 15px 0;color:#2E7D32;font-size:18px;">🎯 Recommendations</h3>
                                <ul style="margin:0;padding-left:20px;line-height:1.8;">
                                    % if ctx.get('usage_percentage', 0) < 50:
                                    <li>Consider increasing your Blanket Order usage to maximize cost savings</li>
                                    % endif
                                    % if ctx.get('expiring_soon', 0) > 0:
                                    <li>You have <strong>{{ ctx.get('expiring_soon', 0) }}</strong> orders expiring soon - plan ahead!</li>
                                    % endif
                                    <li>Schedule a review meeting to optimize your ordering patterns</li>
                                    <li>Explore our new product categories for expanded opportunities</li>
                                </ul>
                            </div>

                            <p style="margin:30px 0 0 0;line-height:1.6;">
                                We value your partnership and are committed to helping you optimize your procurement process. 
                                If you'd like to discuss these insights or explore new opportunities, please contact our team.
                            </p>

                            <p style="margin:20px 0 0 0;">
                                Best regards,<br/>
                                <strong>Your Account Management Team</strong>
                            </p>
                        </td>
                    </tr>

                    <!-- Footer -->
                    <tr>
                        <td style="padding:20px;background-color:#F3E5F5;border-radius:0 0 8px 8px;text-align:center;">
                            <p style="margin:0;color:#6C757D;font-size:12px;">
                                This report is generated automatically every quarter. 
                                For detailed analytics, please visit your customer portal.
                            </p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</div>
            </field>
        </record>

        <!-- ===================================================================== -->
        <!-- AUTOMATED ACTIONS - Für automatische E-Mail-Versendung -->
        <!-- ===================================================================== -->

        <!-- ✅ NEU: Automated Action für Bestätigungs-E-Mails -->
        <record id="automated_action_blanket_order_confirmation_email" model="base.automation">
            <field name="name">Send Blanket Order Confirmation Email</field>
            <field name="model_id" ref="model_sale_blanket_order"/>
            <field name="state">code</field>
            <field name="trigger">on_write</field>
            <field name="filter_domain">[('confirmed', '=', True)]</field>
            <field name="code">
# ✅ ROBUST: Sichere E-Mail-Versendung mit Fehlerbehandlung
try:
    for record in records:
        if record.confirmed and record.partner_id.email:
            template = env.ref('sale_blanket_order.mail_template_blanket_order_confirmation', raise_if_not_found=False)
            if template:
                try:
                    template.send_mail(record.id, force_send=True)
                    log(f"Confirmation email sent for Blanket Order {record.name}")
                except Exception as e:
                    log(f"Failed to send confirmation email for {record.name}: {e}")
            else:
                log("Confirmation email template not found")
except Exception as e:
    log(f"Error in blanket order confirmation automation: {e}")
</field>
            <field name="active">True</field>
        </record>

        <!-- ✅ NEU: Automated Action für Ablauf-Erinnerungen -->
        <record id="automated_action_blanket_order_expiry_reminder" model="base.automation">
            <field name="name">Send Blanket Order Expiry Reminders</field>
            <field name="model_id" ref="model_sale_blanket_order"/>
            <field name="state">code</field>
            <field name="trigger">on_time</field>
            <field name="trg_date_range">30</field>
            <field name="trg_date_range_type">day</field>
            <field name="filter_domain">[('state', '=', 'open'), ('validity_date', '!=', False)]</field>
            <field name="code">
# ✅ ROBUST: Sichere Erinnerungs-E-Mails
try:
    from datetime import datetime, timedelta
    today = fields.Date.today()
    
    # Sende Erinnerungen 30, 14, und 7 Tage vor Ablauf
    reminder_days = [30, 14, 7]
    
    for days_before in reminder_days:
        target_date = today + timedelta(days=days_before)
        
        orders_to_remind = env['sale.blanket.order'].search([
            ('state', '=', 'open'),
            ('validity_date', '=', target_date),
            ('partner_id.email', '!=', False)
        ])
        
        template = env.ref('sale_blanket_order.mail_template_blanket_order_expiry_reminder', raise_if_not_found=False)
        
        for order in orders_to_remind:
            try:
                if template:
                    template.send_mail(order.id, force_send=True)
                    log(f"Expiry reminder sent for {order.name} ({days_before} days before)")
                else:
                    log("Expiry reminder template not found")
            except Exception as e:
                log(f"Failed to send expiry reminder for {order.name}: {e}")
                
except Exception as e:
    log(f"Error in expiry reminder automation: {e}")
</field>
            <field name="active">True</field>
        </record>

    </data>
</odoo>